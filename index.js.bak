// =================================================================
// ARQUIVO: index.js
// DESCRIÃ‡ÃƒO: Bot WhatsApp Baileys com QR Code destacado no terminal
// =================================================================

import dotenv from 'dotenv';
dotenv.config();

import makeWASocket, {
  useMultiFileAuthState,
  DisconnectReason,
  fetchLatestBaileysVersion,
  BufferJSON,
} from '@whiskeysockets/baileys';

import qrcode from 'qrcode-terminal';
import { Boom } from '@hapi/boom';
import logger from './logger.js';

// ===========================
// FUNÃ‡ÃƒO: Mostrar QR no Terminal (bem destacado)
// ===========================
function printBigQR(qr) {
  console.clear();
  console.log("\n\n");
  console.log("===========================================================");
  console.log("==============    ESCANEIE O QR CODE ABAIXO    ============");
  console.log("===========================================================\n");

  qrcode.generate(qr, { small: false });

  console.log("\n===========================================================");
  console.log("====================    AGUARDANDO...    ==================");
  console.log("===========================================================\n\n");
}

// ===========================
// FUNÃ‡ÃƒO PRINCIPAL DE CONEXÃƒO
// ===========================
async function connectToWhatsApp() {
  let state, saveCreds;

  // 1. Se houver SESSION_DATA (modo Render), usa JSON. SenÃ£o, usa arquivos locais.
  if (process.env.SESSION_DATA) {
    logger.info("Carregando sessÃ£o da variÃ¡vel de ambiente...");

    const sessionData = JSON.parse(process.env.SESSION_DATA, BufferJSON.reviver);
    saveCreds = async () => {};

    state = {
      creds: sessionData.creds,
      keys: {
        get: (type, ids) => sessionData.keys[type]?.get(ids),
        set: (data) => {
          Object.assign(sessionData.keys, data);
        }
      }
    };

  } else {
    logger.info("Usando autenticaÃ§Ã£o local (auth_info_multi)...");
    ({ state, saveCreds } = await useMultiFileAuthState("auth_info_multi"));
  }

  const { version, isLatest } = await fetchLatestBaileysVersion();
  logger.info(`Baileys versÃ£o: ${version.join('.')} (mais recente: ${isLatest})`);

  const sock = makeWASocket({
    version,
    logger,
    printQRInTerminal: false, // desativa QR padrÃ£o
    auth: state,
    browser: ["DudaBot", "Chrome", "1.0"],
  });

  // ===========================
  // MONITORAR EVENTOS DE CONEXÃƒO
  // ===========================
  sock.ev.on("connection.update", async (update) => {
    const { connection, lastDisconnect, qr } = update;

    if (qr) {
      printBigQR(qr); // MOSTRA O QR MUITO DESTAQUE
    }

    if (connection === "open") {
      console.clear();
      logger.info("ğŸ‰ BOT CONECTADO AO WHATSAPP COM SUCESSO!");
    }

    if (connection === "close") {
      const statusCode = lastDisconnect?.error?.output?.statusCode;

      logger.error(`ConexÃ£o fechada. CÃ³digo: ${statusCode}`);

      if (statusCode === DisconnectReason.loggedOut) {
        logger.fatal("SessÃ£o expirada. SerÃ¡ necessÃ¡rio gerar novo QR ou nova SESSION_DATA.");
        return;
      }

      logger.warn("Reconectando automaticamente...");
      connectToWhatsApp();
    }
  });

  sock.ev.on("creds.update", saveCreds);

  // ====================
  // RECEBIMENTO DE MENSAGENS
  // ====================
  
  // ===========================================
  
  // RESPOSTAS AUTOMÃTICAS DA DUDA
  
  // ===========================================
  
  sock.ev.on("messages.upsert", async ({ messages }) => {
const msg = messages[0];
if (!msg.message) return;
const from = msg.key.remoteJid;
if (from.endsWith("@g.us")) {
console.log("Mensagem ignorada (grupo)");
return;
}
const msg = messages[0];    const from = msg.key.remoteJid;    if (from.endsWith('@g.us')) {        console.log('Mensagem ignorada (grupo)');        return;    }
  try {
    const msg = messages[0];
    if (!msg || !msg.message) return;

    const from = msg.key.remoteJid;
    const isGroup = from.endsWith("@g.us");
    if (isGroup) return;

    const text = msg.message.conversation 
      || msg.message.extendedTextMessage?.text 
      || msg.message?.editedMessage?.message?.conversation;

    if (!text) return;

    logger.info(`Mensagem recebida de ${from}: ${text}`);

    const lower = text.toLowerCase().trim();

    if (lower === "oi" || lower === "olÃ¡" || lower === "bom dia" || lower === "boa tarde" || lower === "boa noite") {
      await sock.sendMessage(from, { text: "OlÃ¡! Eu sou a Duda ğŸ¤–. Como posso ajudar vocÃª hoje?" });
    }

  } catch (e) {
    logger.error("Erro no handler de mensagens", e);
  }
});
  const msg = messages[0];
  if (!msg || !msg.message) return;
  const from = msg.key.remoteJid;
  const isGroup = from.endsWith("@g.us");
  if (isGroup) return;
  const text = msg.message.conversation || msg.message.extendedTextMessage?.text;
  if (!text) return;
  logger.info(`Mensagem recebida de ${from}: ${text}`);
  if (text.toLowerCase() === "oi" || text.toLowerCase() === "olÃ¡") {
    await sock.sendMessage(from, { text: "OlÃ¡! Eu sou a Duda ğŸ¤–. Como posso ajudar vocÃª hoje?" });
  }
});
    const msg = messages[0];
    if (!msg.message) return;

    const from = msg.key.remoteJid;

    // ğŸš« BLOQUEIO ABSOLUTO DE GRUPOS
    if (from.endsWith("@g.us")) {
      logger.warn(`Mensagem ignorada (grupo detectado): ${from}`);
      return;
    }

    const text = msg.message.conversation || msg.message.extendedTextMessage?.text || "";
    if (!text) return;

    logger.info(`Mensagem recebida de ${from}: ${text}`);

    const user = text.trim().toLowerCase();

    if (user === "oi" || user === "olÃ¡") {
      await sock.sendMessage(from, { text: "OlÃ¡! Eu sou a Duda ğŸ¤–. Como posso ajudar vocÃª hoje?" });
    }
  });
    
    }

    
    if (user.includes("mensalidade")) {
      
      return await sock.sendMessage(from, {
        
        text: "ğŸ’³ *InformaÃ§Ãµes sobre mensalidade*\n\nâ€¢ Pagamento via boleto ou cartÃ£o\nâ€¢ Descontos para pagamento antecipado\nâ€¢ 2Âª via direto no portal do aluno\n\nQuer que eu gere o link para vocÃª?",
      
      });
    
    }

    
    if (user.includes("matrÃ­cula") || user.includes("matricula")) {
      
      return await sock.sendMessage(from, {
        
        text: "ğŸ“ *InformaÃ§Ãµes sobre matrÃ­cula*\n\nTemos vagas abertas! Posso te enviar:\n1ï¸âƒ£ Cursos disponÃ­veis\n2ï¸âƒ£ DocumentaÃ§Ã£o necessÃ¡ria\n3ï¸âƒ£ Formas de ingresso\n\nO que deseja?",
      
      });
    
    }

    
    if (user.includes("ead") || user.includes("curso")) {
      
      return await sock.sendMessage(from, {
        
        text: "ğŸ“ *Cursos EAD Uninter*\n\nTemos graduaÃ§Ã£o, pÃ³s e cursos livres.\nQuer ver lista completa ou falar com um atendente?",
      
      });
    
    }

    
    return await sock.sendMessage(from, {
      
      text: "ğŸ¤– NÃ£o entendi exatamenteâ€¦ mas posso ajudar com:\n\nâ€¢ MatrÃ­cula\nâ€¢ Mensalidade\nâ€¢ Cursos\nâ€¢ Polo Caratinga\n\nDigite uma palavra-chave (ex: *matrÃ­cula*).",
    
    });
  
  });
    }
  });
}

// ===========================
// INICIAR BOT
// ===========================
connectToWhatsApp();
